services:
  php:
    build:
      context: .
      dockerfile: .docker/php/Dockerfile
    container_name: brc_php
    restart: unless-stopped
    env_file: ".env"
    volumes:
      - ./:/var/www/html
    depends_on:
      - redis
    networks:
      - brc_network

  cron:
    build:
      context: .
      dockerfile: .docker/php/Dockerfile
    container_name: brc_cron
    restart: unless-stopped
    volumes:
      - ./:/var/www/html
      - ./.docker/cron/crontab:/etc/cron.d/app-cron
    env_file: ".env"
    depends_on:
      - redis
    networks:
      - brc_network
    command: >
      sh -c "chmod 0644 /etc/cron.d/app-cron && \
             crontab /etc/cron.d/app-cron && \
             echo 'Starting cron daemon...' && \
             crond -b -l 8 -L /var/log/cron_daemon.log && \
             echo 'Cron daemon started in background. Tailing job output FIFO.' && \
             tail -F /var/log/cron.fifo"
    # Use -F for robustness with log rotation/recreation
    # Explanation of crond flags:
    # -b : Run in background (daemonize). This is important because `tail -F` needs to be the foreground process.
    # -l 8 : Set log level (0-8, 8 is debug). Logs from crond itself (not your jobs) will go to syslog or the specified log file.
    # -L /var/log/cron_daemon.log : Log crond's own messages to this file (optional, can also go to syslog).

  nginx:
    build:
      context: .docker/nginx
      dockerfile: Dockerfile
    container_name: brc_nginx
    restart: unless-stopped
    env_file: ".env"
    volumes:
      - ./:/var/www/html
    ports:
      - "${NGINX_HOST_PORT:-8080}:80"
    depends_on:
      - php
    networks:
      - brc_network

  socket:
    build:
      context: .
      dockerfile: .docker/socket/Dockerfile
    container_name: brc_socket
    restart: unless-stopped
    ports:
      - "${SOCKET_HOST_PORT:-8085}:${SOCKET_PORT:-8085}"
    volumes:
      - /usr/src/app/node_modules
      - ./brc.db:/usr/src/app/brc.db:ro
      - ./brc.db-shm:/usr/src/app/brc.db-shm:ro
      - ./brc.db-wal:/usr/src/app/brc.db-wal:ro
    env_file: ".env"
    depends_on:
      - redis
    networks:
      - brc_network

  redis:
    image: redis:7-alpine
    container_name: brc_redis
    env_file: ".env"
    restart: unless-stopped
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --port ${REDIS_PORT}
    networks:
      - brc_network

volumes:
  redis_data:
  xdebug_logs:
    driver: local

networks:
  brc_network:
    driver: bridge
